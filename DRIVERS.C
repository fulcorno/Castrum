/* drivers.c
  carica i fonts, il driver att400 e tutti i dati e le proceudre di
  uso generale per la gestione della grafica e della tastiera.
*/

#include <graphics.h>
#include <stdio.h>
#include <string.h>
#include <io.h>
#include <alloc.h>
#include <dos.h>
#include <assert.h>
#include <stdlib.h>

#include "drivers.h"

/* def variabili & init costanti */

unsigned int *Badr ;
char _8to7[256] =
    "                                 !\"#$%&'()*+,-./0123456789:;<=>?"
    "@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~ "
    "CueaaaaceeeiiiAAEeEooouuyoUcLYPfaiounN^^?--24!<>***||||\\\\||\\///\\"
    "\\--|-+||\\/--|-+----\\\\//++//*****abcpSsutFTOd#0e^=~><||-~^..Vn2* " ;
char Fills[][8] = {
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },  /* nero */
    { 0x00, 0x44, 0x00, 0x00, 0x00, 0x44, 0x00, 0x00 },  /* G1 */
    { 0x00, 0x44, 0x22, 0x00, 0x00, 0x44, 0x22, 0x00 },  /* G2 */
    { 0x00, 0x44, 0x66, 0x00, 0x00, 0x44, 0x66, 0x00 },  /* G3 */
    { 0x00, 0x66, 0x66, 0x00, 0x00, 0x66, 0x66, 0x00 },  /* G4 */
    { 0x11, 0x66, 0x66, 0x00, 0x11, 0x66, 0x66, 0x00 },  /* G5 */
    { 0x88, 0x66, 0x66, 0x11, 0x88, 0x66, 0x66, 0x11 },  /* G6 */
    { 0x99, 0x66, 0x66, 0x88, 0x99, 0x66, 0x88, 0x88 },  /* G7 */
    { 0x99, 0x66, 0x66, 0x99, 0x99, 0x66, 0x66, 0x99 },  /* G8 */
    { 0x99, 0x66, 0x66, 0xdd, 0x99, 0x66, 0x66, 0xdd },  /* G9 */
    { 0xbb, 0x66, 0x66, 0xdd, 0xbb, 0x66, 0x66, 0xdd },  /* G10 */
    { 0xbb, 0x66, 0xee, 0xdd, 0xbb, 0x66, 0xee, 0xdd },  /* G11 */
    { 0xbb, 0x77, 0xee, 0xdd, 0xbb, 0x77, 0xee, 0xdd },  /* G12 */
    { 0xbb, 0x77, 0xff, 0xdd, 0xbb, 0x77, 0xff, 0xdd },  /* G13 */
    { 0xbb, 0xff, 0xff, 0xdd, 0xbb, 0xff, 0xff, 0xdd },  /* G14 */
    { 0xff, 0xee, 0xff, 0xff, 0xff, 0xee, 0xff, 0xff },  /* G15 */
    { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },  /* bianco */
    { 0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55 },  /* grigio */
    { 0x77, 0xaa, 0xdd, 0xaa, 0x77, 0xaa, 0xdd, 0xaa },  /* rombi */
    { 0xdb, 0xbd, 0x42, 0xdb, 0xdb, 0x42, 0xbd, 0xdb },  /* quadri */
    { 0x00, 0x7f, 0x7f, 0x7f, 0x00, 0xf7, 0xf7, 0xf7 },  /* mattoni */
    { 0xfb, 0x2a, 0xef, 0xa8, 0xbf, 0xa2, 0xfe, 0x8a },  /* lisca */
    { 0xbb, 0xbb, 0x38, 0xd7, 0xef, 0xd7, 0x38, 0xbb },  /* quadrombi */
    { 0x7f, 0x7f, 0xbe, 0xc9, 0xf7, 0xf7, 0xc9, 0xbe },  /* esagoni */
    { 0xc7, 0xbb, 0x45, 0x55, 0x45, 0xbb, 0xc7, 0xff },  /* cerchi */
    { 0xd6, 0xba, 0x7c, 0xee, 0xd6, 0xba, 0x7c, 0xee },  /* frecce */
    { 0xff, 0xbf, 0x47, 0x7b, 0xff, 0xfb, 0xf5, 0xce },  /* lago */
    { 0x7e, 0xbd, 0xdb, 0xe7, 0xe7, 0xdb, 0xbd, 0x7e },  /* rombi2 */
    { 0xff, 0xfb, 0xb7, 0xb7, 0xd5, 0xe5, 0x83, 0xe7 },  /* erba */
    { 0xf8, 0xf1, 0xe3, 0xc7, 0x8f, 0x1f, 0x3e, 0x7c },  /* diagonal */
    { 0xef, 0xc7, 0x83, 0x01, 0x83, 0xc7, 0xef, 0xff },  /* quadri2 */
    { 0x18, 0x3c, 0x7e, 0xff, 0xff, 0xe7, 0xc3, 0x81 },  /* zigzag */
    { 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x00 },  /* pianella */
    { 0xa0, 0xaf, 0xa0, 0xaf, 0xa0, 0xaf, 0xa0, 0xaf },  /* parquet */
    { 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc },  /* righe */
    { 0xfe, 0xc6, 0x82, 0x82, 0x82, 0xc6, 0xfe, 0x00 },  /* palle */
    { 0xc1, 0xbe, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0xbe },  /* ottagon */
    { 0xf0, 0xf0, 0xf0, 0xf0, 0x0f, 0x0f, 0x0f, 0x0f },  /* quadri3 */
    { 0xf1, 0xe1, 0xc1, 0xc3, 0x87, 0x9f, 0xbf, 0xbf },  /* foglie */
    { 0xff, 0xef, 0xc7, 0xab, 0x01, 0xab, 0xef, 0xc7 },  /* fiori */
    { 0xff, 0xab, 0xab, 0xc7, 0x6d, 0x6d, 0xab, 0xc7 },  /* bracci */
    { 0,0,0,0,0,0,0,0 } 				 /* dummy */
} ;

/* IMPLEMENTATION */

static struct {
    char const * const nome ;
    char loaded ;
    int table ;
} fonts[] =
    {	"****",1,0,
	"trip",0,0,
	"litt",0,0,
	"sans",0,0,
	"goth",0,0,
	"bold",0,0,
	"euro",0,0,
	"lcom",0,0,
	"scri",0,0,
	"simp",0,0,
	"tscr",0,0
    } ;

void initgraphscreen(int mode)   /* pubblica */
{
    int gd,gm,y ;

    gd=mode ;
    getmoderange(gd,&y,&gm) ; /* setta il modo a risoluzione massima */
    initgraph(&gd,&gm,getenv("BGI")) ;
    Badr = loadfile(grpath("badr")) ;
} /* InitGraphScreen */

static void near pascal loadfont(int n, const char *path)
{
    long w ;
    void * ptr ;
    FILE * f ;
    char buf[100] ;

    fonts[n].loaded = 1 ;
    strcpy(buf,path) ;
    strcat(buf,fonts[n].nome) ;
    strcat(buf,".chr") ;
    f = fopen (buf,"rb") ;
    if(!f) fprintf(stderr,"Can\'t open file \"%s\"\n",buf) ;
    assert(f) ;
    w = (int)filelength(fileno(f)) ;
    ptr = farmalloc(w) ;
    assert(ptr) ;
    fread(ptr,(size_t)w,1,f) ;
    fclose(f);
    fonts[n].table= registerfarbgifont(ptr) ;
} /* loadfont */

void selectfont(int n, int size) /* pubblica */
{
    char buf[100] ;
    strcpy(buf,getenv("BGI")) ;
    strcat(buf,"\\") ;
    if (!fonts[n].loaded) loadfont(n,buf) ;
    settextstyle(fonts[n].table,HORIZ_DIR,size);
} /* SelectFont */

/*
 * Carica da disco il file specificato, allocandone la memoria necessaria.
 * Questa memoria portr… essere liberata con free() oppure lasciata occupata.
 */
void * loadfile(const char * name)
{
    FILE * f ;
    void * p ;
    long size ;
    f = fopen(name,"rb") ;
    if(!f) fprintf(stderr,"Can\'t open file \"%s\"\n",name) ;
    assert(f);
    size = filelength(fileno(f)) ;
    assert(size<0x10000lu);
    p = malloc((size_t)size) ;
    assert(p) ;
    fread(p,(size_t)size,1,f) ;
    fclose(f) ;
    return p ;
}

/*
 * Crea il file name completo (allocato in un buffer STATICO) per un file
 * nella directory grafica
 */
char * grpath(const char * name) /* pubblica */
{
    static char buf[25] ;

    strcpy(buf,getdrivername()) ;
    strcat(buf,"\\") ;
    strcat(buf,name) ;
    if (!strchr(buf,'.')) strcat(buf,".byt") ;
    return buf ;
}

/* end of module DRIVERS.c */
